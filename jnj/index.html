<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">
<html>
    <head>
        <title>J&J GSD Desktop Agent</title>
    </head>
    <body>
        <div id="myApp">
            <h1>AWS Connect - J&amp;J GSD Agent Desktop 7</h1>
        </div>
        <div style="width: 800px; height: 500px; "> 
            <div id="containerDiv" style="float:left; width: 320px; min-width: 200px; height: 465px; min-height: 400px; ">
                <!--Amazon CCP will go here-->
            </div>
            <textarea id="agentMsgs" style="float:right; width: 460px; min-width: 200px; height: 460px; min-height: 400px; "></textarea>
        </div>
        <br>
        <textarea id="logMsgs" rows="12" cols="120"></textarea>
        <br>

        <!-- see https://github.com/aws/amazon-connect-streams -->
        <script src="amazon-connect-v1.2.0-21-ge9b5224.js"></script>

        <script type="text/javascript">

            window.myCPP = window.myCPP || {};
            //var ccpUrl = "https://atosjnjsandbox.awsapps.com/connect/ccp#/";
            var ccpUrl = "https://jnj-gsd-us.awsapps.com/connect/ccp#/";
            var agentMsgs = document.getElementById("agentMsgs");
            var logMsgs = document.getElementById("logMsgs");
            console.log("LOG LOG");
            connect.core.initCCP(containerDiv, {
                ccpUrl: ccpUrl,
                loginPopup: false,
                softphone: {
                    allowFramedSoftphone: true
                }
            });
            connect.contact(subscribeToContactEvents);
            function subscribeToContactEvents(contact) {
                window.myCPP.contact = contact;
                logMsgToScreen("Subscribing to events for contact");
                if (contact.getActiveInitialConnection()
                        && contact.getActiveInitialConnection().getEndpoint()) {
                    logMsgToScreen("New contact is from " + contact.getActiveInitialConnection().getEndpoint().phoneNumber.toString());
                    displayMsgToAgent("Calling: " + contact.getActiveInitialConnection().getEndpoint().phoneNumber);
                } else {
                    logMsgToScreen("This is an existing contact for this agent");
                }
                logMsgToScreen("Contact is from queue " + contact.getQueue().name);
                displayMsgToAgent("Queue: " + contact.getQueue().name.toString());
                logMsgToScreen("Contact attributes are " + JSON.stringify(contact.getAttributes()));
                displayMsgToAgent("WWID: " + contact.getAttributes().get("WWID").toString());
                contact.onIncoming(eventContactIncoming);
                contact.onAccepted(eventContactAccepted);
                contact.onConnected(eventContactConnected);
                contact.onEnded(eventContactEnded);
            }
            function eventContactIncoming(contact) {
                if (contact) {
                    logMsgToScreen("[contact.onIncoming] Contact is incoming. Contact state is " + contact.getStatus().type);
                }
                logMsgToScreen("[contact.onIncoming] " + JSON.stringify(contact));
            }
            function eventContactAccepted(contact) {
                if (contact) {
                    logMsgToScreen("[contact.onAccepted] Contact accepted by agent. Contact state is " + contact.getStatus().type);
                }
                logMsgToScreen("[contact.onAccepted] " + JSON.stringify(contact));
            }
            function eventContactConnected(contact) {
                if (contact) {
                    logMsgToScreen("[contact.onConnected] Contact connected to agent. Contact state is " + contact.getStatus().type);
                }
                logMsgToScreen("[contact.onConnected] " + JSON.stringify(contact));
            }
            function eventContactEnded(contact) {
                if (contact) {
                    logMsgToScreen("[contact.onEnded] Contact has ended. Contact state is " + contact.getStatus().type);
                }
                logMsgToScreen("[contact.onEnded] " + JSON.stringify(contact));
            }


            connect.agent(subscribeToAgentEvents);
            function subscribeToAgentEvents(agent) {
                window.myCPP.agent = agent;
                agentMsgs.innerHTML = 'Hi ' + agent.getName() + ' !\n';
                logMsgToScreen("Subscribing to events for agent " + agent.getName());
                logMsgToScreen("Agent is currently in status of " + agent.getStatus().name);
                agent.onRefresh(eventAgentRefresh);
                agent.onRoutable(eventAgentRoutable);
                agent.onNotRoutable(eventAgentNotRoutable);
                agent.onOffline(eventAgentOffline);
                agent.onError(eventAgentError);
            }
            function eventAgentRefresh(agent) {
                logMsgToScreen("[agent.onRefresh] Agent data refreshed. Agent status is " + agent.getStatus().name);
                logMsgToScreen("[agent.onRefresh] " + JSON.stringify(agent));
            }
            function eventAgentRoutable(agent) {
                logMsgToScreen("[agent.onRoutable] Agent is routable. Agent status is " + agent.getStatus().name);
                logMsgToScreen("[agent.onRoutable] " + JSON.stringify(agent));
            }
            function eventAgentNotRoutable(agent) {
                logMsgToScreen("[agent.onNotRoutable] Agent is online, but not routable. Agent status is " + agent.getStatus().name);
                logMsgToScreen("[agent.onNotRoutable] " + JSON.stringify(agent));
            }
            function eventAgentOffline(agent) {
                logMsgToScreen("[agent.onOffline] Agent is offline. Agent status is " + agent.getStatus().name);
                logMsgToScreen("[agent.onOffline] " + JSON.stringify(agent));
            }
            function eventAgentError(agent) {
                logMsgToScreen("[agent.onError] Agent is offline. Agent status is " + agent.getStatus().name);
                logMsgToScreen("[agent.onError] " + JSON.stringify(agent));
            }
            function goAvailable() {
                var routableState = window.myCPP.agent.getAgentStates().filter(function (state) {
                    return state.type === connect.AgentStateType.ROUTABLE;
                })[0];
                window.myCPP.agent.setState(routableState, {
                    success: function () {
                        logMsgToScreen("Set agent status to Available (routable) via Streams");
                    },
                    failure: function () {
                        logMsgToScreen("Failed to set agent status to Available (routable) via Streams");
                    }
                });
            }
            function goOffline() {
                var offlineState = window.myCPP.agent.getAgentStates().filter(function (state) {
                    return state.type === connect.AgentStateType.OFFLINE;
                })[0];
                window.myCPP.agent.setState(offlineState, {
                    success: function () {
                        logMsgToScreen("Set agent status to Offline via Streams");
                    },
                    failure: function () {
                        logMsgToScreen("Failed to set agent status to Offline via Streams");
                    }
                });
            }
            function acceptContact() {
                window.myCPP.contact.accept({
                    success: function () {
                        logMsgToScreen("Accepted contact via Streams");
                    },
                    failure: function () {
                        logMsgToScreen("Failed to accept contact via Streams");
                    }
                });
            }
            function disconnectContact() {
                //cannot do contact.destroy(), can only destroy (hang-up) agent connection
                window.myCPP.contact.getAgentConnection().destroy({
                    success: function () {
                        logMsgToScreen("Disconnected contact via Streams");
                    },
                    failure: function () {
                        logMsgToScreen("Failed to disconnect contact via Streams");
                    }
                });
            }



            function displayMsgToAgent(msg) {
                console.log("dta: " + msg);
                agentMsgs.innerHTML = "" + String(agentMsgs.innerHTML) + String(msg) + "\n";
            }

            function logMsgToScreen(msg) {
                console.log('lmts: ' + msg);
                logMsgs.innerHTML = '' + new Date().toLocaleTimeString() + ' ' + msg + '\n' + logMsgs.innerHTML;
            }

            //function logInfoMsg(msg) {
            //    console.log('lim: ' + msg);
            //    connect.getLog().info(msg);
            //    logMsgToScreen(msg);
            //}
            //function logInfoEvent(eventMsg) {
            //    console.log('lie: ' + msg);
            //    connect.getLog().info(eventMsg);
            //}
            function displayAgentStatus(status) {
                eventMsgs.innerHTML = 'Status: ' + status;
            }

        </script>
    </body>
</html>
